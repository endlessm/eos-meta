#!/bin/bash

cmd_name=$(basename $0)

usage () {
    cat <<EOF
Usage: $cmd_name QUEST-NAME|all
Reset the state of QUEST-NAME, you can specify "all",
to do a full reset of all the quests and a reset of the
desktop icons generated by quests.

  -h, --help                display this help and exit

EOF
}

args=$(getopt -o h -l "help" -n "$cmd_name" -- "$@")

if [ $? != 0 ]; then
    exit 1
fi

eval set -- "$args"

quest_name=""
while true; do
    case "$1" in
        -h|--help)
        usage
        exit 0
        ;;
    --)
        shift
        ;;
    *)
        quest_name=$1
        break
        ;;
    esac
done

if [ -z $quest_name ]; then
    echo "Please specify a quest name or 'all'"
    exit 1
elif [ $quest_name == 'all' ]; then
    rm -rf ~/.var/app/com.endlessm.GameStateService/data/*
    eos-reset-desktop
else
    state_filename=~/.var/app/com.endlessm.GameStateService/data/state.json

    flatpak run --command=true com.endlessm.HackToolbox 2> /dev/null
    if [ $? != 0 ]; then
        echo "You have to install 'com.endlessm.HackToolbox' in order to reset a single quest"
        exit 1
    fi

    flatpak run --command=jq --filesystem=~/.var/app/com.endlessm.GameStateService \
        com.endlessm.HackToolbox \
        "del(.\"quest.$quest_name\")" \
        $state_filename > $state_filename.bak
    mv $state_filename.bak $state_filename
fi
